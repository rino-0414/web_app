<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>タスク一覧</title>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var today = new Date();
            var currentYear = today.getFullYear();
            var currentMonth = today.getMonth();
            var currentDate = today.getDate();
            var tasks = {};

            function fetchTasks() {
                $.get("{{ url_for('main.get_all_tasks') }}", function(data) {
                    tasks = data.reduce(function(acc, task) {
                        var date = task[0];
                        if (!acc[date]) {
                            acc[date] = [];
                        }
                        acc[date].push(task[1]);
                        return acc;
                    }, {});
                    generateCalendar(currentYear, currentMonth);
                });
            }

            function generateCalendar(year, month) {
                var daysInMonth = new Date(year, month + 1, 0).getDate();
                var firstDay = new Date(year, month, 1).getDay();
                var calendar = '<table><tr>';
                var daysOfWeek = ['日', '月', '火', '水', '木', '金', '土'];
                
                for (var i = 0; i < daysOfWeek.length; i++) {
                    calendar += '<th>' + daysOfWeek[i] + '</th>';
                }
                calendar += '</tr><tr>';
                
                for (var i = 0; i < firstDay; i++) {
                    calendar += '<td></td>';
                }
                
                for (var day = 1; day <= daysInMonth; day++) {
                    if ((firstDay + day - 1) % 7 == 0) {
                        calendar += '</tr><tr>';
                    }
                    var dateStr = year + '-' + (month + 1).toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
                    var cellClass = (year === currentYear && month === currentMonth && day === currentDate) ? 'calendar-day today' : 'calendar-day';
                    var pinIcon = tasks[dateStr] ? '<span class="pin-icon">📌</span>' : '';
                    calendar += '<td class="' + cellClass + '" data-date="' + dateStr + '">' + day + pinIcon + '</td>';
                }
                
                calendar += '</tr></table>';
                $('#calendar').html(calendar);
                $('#current-month').text(year + '年 ' + (month + 1) + '月');
            }
            
            fetchTasks();
            
            $('#prev-month').click(function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                generateCalendar(currentYear, currentMonth);
            });
            
            $('#next-month').click(function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                generateCalendar(currentYear, currentMonth);
            });
            
            $(document).on('click', '.calendar-day', function() {
                var date = $(this).data('date');
                $.get("{{ url_for('main.get_tasks') }}", { date: date }, function(data) {
                    var taskDetails = data.map(function(task) {
                        return '<p><strong>' + task[0] + '</strong> ' + task[1] + '</p>';
                    }).join('');
                    $('#task-details').html(taskDetails);
                    $('#task-date').val(date);
                    $('#task-modal').show();
                });
            });
            
            $('#task-form').submit(function(event) {
                event.preventDefault();
                var title = $('#task-title').val();
                var description = $('#task-description').val();
                var due_date = $('#task-date').val();
                
                $.post("{{ url_for('main.add') }}", {
                    title: title,
                    description: description,
                    due_date: due_date
                }, function(data) {
                    location.reload();
                });
            });
            
            $('#task-modal-close').click(function() {
                $('#task-modal').hide();
            });

            $('#add-task-button').click(function() {
                $('#task-form-container').toggle();
            });
        });
    </script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        .calendar-day {
            cursor: pointer;
        }
        .today {
            background-color: rgb(255, 248, 152); /* 今日の日付をハイライト */
        }
        .pin-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 12px;
        }
        #task-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #task-form-container {
            display: none;
        }
        #task-details p {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <h1>タスク一覧</h1>
    <div>
        <button id="prev-month">前の月</button>
        <span id="current-month"></span>
        <button id="next-month">次の月</button>
    </div>
    <div id="calendar"></div>
    
    <div id="task-modal">
        <div id="task-details"></div>
        <button id="add-task-button">追加</button>
        <div id="task-form-container">
            <form id="task-form">
                <label for="task-title">タイトル</label>
                <input type="text" id="task-title" name="title" required>
                <label for="task-description">説明</label>
                <textarea id="task-description" name="description"></textarea>
                <input type="hidden" id="task-date" name="due_date">
                <button type="submit">追加</button>
            </form>
        </div>
        <button type="button" id="task-modal-close">閉じる</button>
    </div>
    
    <h2>期限が近いタスク</h2>
    <ul>
        {% for task in tasks %}
            <li>{{ task[1] }} - {{ task[3] }}</li>
        {% endfor %}
    </ul>
    <a href="{{ url_for('main.task_list') }}">タスク一覧を見る</a>
</body>

</html>